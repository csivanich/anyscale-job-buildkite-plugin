#!/usr/bin/env bash

set -euo pipefail

fail(){
    "ERROR: $*"
    exit 1
}

PREFIX="BUILDKITE_PLUGIN_ANYSCALE_JOB_"
env | grep "$PREFIX"

file="$BUILDKITE_PLUGIN_ANYSCALE_JOB_FILE"
name="$BUILDKITE_PLUGIN_ANYSCALE_JOB_NAME"
description="$BUILDKITE_PLUGIN_ANYSCALE_JOB_DESCRIPTION"

if [[ -z "$file" ]];then
    fail "Missing 'file' property"
fi

cat "$file"

if [[ -n "$name" ]];then
    echo "$name"
fi

if [[ -n "$description" ]];then
    echo "$description"
fi

echo "~~~ Installing Anyscale CLI"
pip3 install -U anyscale
export PATH="/var/lib/buildkite-agent/.local/bin/:$PATH"

if ! anyscale --version;then
    fail "Cannot find Anyscale CLI post-install"
fi

echo "~~~ Running Anyscale Job"
anyscale job submit \
    --wait \
    --name "$name" \
    --description "$description" \
    -f "$file"
